<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Online Airline Ticketing System</title>
  <link rel="stylesheet" href="/static/css/flight-search-style.css">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

</head>

<link rel="stylesheet" href="/static/css/flight-search-style.css">
<style>
  .admin-container {
    max-width: 1400px;
    margin: 20px auto;
    padding: 20px;
  }

  .admin-section {
    background: #fff;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
  }

  .flight-management-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  .flight-management-table th {
    background-color: #9bacd8;
    color: white;
    padding: 12px;
    text-align: left;
    font-size: 0.9em;
  }

  .flight-management-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #ddd;
  }

  .flight-management-table tr:hover {
    background-color: #f5f5f5;
  }

  .action-btn {
    padding: 6px 12px;
    margin-right: 5px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    color: white;
    font-size: 0.85em;
  }

  .edit-btn {
    background-color: #ff9800;
  }

  .edit-btn:hover {
    background-color: #e68900;
  }

  .delete-btn {
    background-color: #f44336;
  }

  .delete-btn:hover {
    background-color: #da190b;
  }

  .add-flight-form {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: flex-end;
  }

  .add-flight-form input,
  .add-flight-form select {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    flex: 1;
    min-width: 120px;
  }

  .add-flight-form button {
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }

  .add-flight-form button:hover {
    background-color: #45a049;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
  }

  .modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 90%;
    max-width: 600px;
    border-radius: 8px;
  }

  .close-btn {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .close-btn:hover {
    color: black;
  }

  #editFlightForm input,
  #editFlightForm select {
    width: 100%;
    margin-bottom: 15px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }

  #editFlightForm button {
    width: 100%;
    padding: 10px;
    background-color: #004d99;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
</style>

<body>
<nav class="navbar sticky-top glass-nav">
  <div class="container-fluid">
    <span class="navbar-brand mb-0 h1">Online Airline Ticketing System - Admin</span>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
      aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link active" href="/adminSearchPage">Search & Manage Flights</a></li>
        <li class="nav-item"><a class="nav-link" href="/userManagement">User Management</a></li>
        <li class="nav-item"><a class="nav-link" href="/reservations">Reservations List</a></li>
        <li class="nav-item"><a class="nav-link" href="/userProfile">Profile</a></li>
      </ul>
    </div>
  </div>
</nav>

<div id="carouselExampleSlidesOnly" class="carousel slide carousel-fade" data-bs-ride="carousel">
  <div class="carousel-inner">
    <div class="carousel-item active">
      <img src="https://images.pexels.com/photos/615060/pexels-photo-615060.jpeg" class="d-block w-100" alt="Admin Dashboard">
      <div class="carousel-caption">
        <h1>Admin Flight Management</h1>
      </div>
    </div>
  </div>
</div>

<div class="admin-container">
  <div class="admin-section">
    <h2 class="text-center fw-bold mb-4" style="color:#333;">Search Flights</h2>
    <div class="flight-search-container">
      <form id="flightSearchForm" class="row g-3">
        <div class="col-12 mb-4 trip-type-selector">
          <input type="radio" class="btn-check" name="tripType" id="roundTrip" autocomplete="off" checked>
          <label class="btn btn-outline-primary" for="roundTrip">Round Trip</label>
          <input type="radio" class="btn-check" name="tripType" id="oneWay" autocomplete="off">
          <label class="btn btn-outline-primary" for="oneWay">One Way</label>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <label for="searchOrigin" class="form-label">Departure City *</label>
            <select class="form-select" id="searchOrigin" required>
              <option value="">Select departure city</option>
              {{#each cities}}
              <option value="{{code}}">{{name}} ({{code}})</option>
              {{/each}}
            </select>
          </div>

          <div class="col-md-3">
            <label for="searchDestination" class="form-label">Destination City *</label>
            <select class="form-select" id="searchDestination" required>
              <option value="">Select destination city</option>
              {{#each cities}}
              <option value="{{code}}">{{name}} ({{code}})</option>
              {{/each}}
            </select>
          </div>

          <div class="col-md-3">
            <label for="departureDate" class="form-label">Departure *</label>
            <input type="date" class="form-control" id="departureDate" required>
          </div>

          <div class="col-md-3" id="returnDateContainer">
            <label for="returnDate" class="form-label">Return *</label>
            <input type="date" class="form-control" id="returnDate" required>
          </div>
        </div>

        <div class="row g-3 w-100">
          <div class="col-12 d-flex justify-content-end mt-3">
            <div class="col-md-2">
              <button type="submit" class="btn btn-success w-100">Search Flights</button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <h3 class="mt-5 mb-3">Search Results</h3>
    <div id="flightResults" class="row">
      <p class="text-muted">Search for flights to see results here.</p>
    </div>
  </div>

  <!-- Flight Management Section -->
  <div class="admin-section">
    <h2 class="fw-bold mb-4">Flight Management</h2>
    
    <div class="add-flight-form">
      <h3 class="w-100 mb-3">Create New Flight</h3>
      <form id="newFlightForm" class="add-flight-form">
        <input type="text" id="newFlightNumber" placeholder="Flight # (e.g., AA123)" required>
        <select id="newOrigin" required>
          <option value="">Origin</option>
          {{#each cities}}
          <option value="{{code}}">{{code}} - {{name}}</option>
          {{/each}}
        </select>
        <select id="newDestination" required>
          <option value="">Destination</option>
          {{#each cities}}
          <option value="{{code}}">{{code}} - {{name}}</option>
          {{/each}}
        </select>
        <input type="datetime-local" id="newSchedule" required>
        <input type="number" id="newPrice" placeholder="Price" required min="0" step="0.01">
        <input type="text" id="newAircraftType" placeholder="Aircraft Type (e.g., B737)" required>
        <input type="number" id="newSeatCapacity" placeholder="Capacity" required min="1">
        <input type="text" id="newAirline" placeholder="Airline Name" required>
        <button type="submit" id="addFlightBtn">Add Flight</button>
      </form>
    </div>

    <hr class="my-4">

    <h3 class="mb-3">All Flights</h3>
    <div id="flightsLoading" class="text-center">
      <p>Loading flights...</p>
    </div>
    <table class="flight-management-table" id="flightTable" style="display: none;">
      <thead>
        <tr>
          <th>Flight #</th>
          <th>Origin</th>
          <th>Destination</th>
          <th>Schedule</th>
          <th>Price</th>
          <th>Aircraft</th>
          <th>Capacity</th>
          <th>Seats Available</th>
          <th>Airline</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="flightTableBody">
      </tbody>
    </table>
  </div>
</div>

<!-- Edit Flight Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2>Update Flight Details</h2>
    <form id="editFlightForm">
      <input type="hidden" id="editFlightId">
      <input type="text" id="editFlightNumber" placeholder="Flight Number" required>
      <select id="editOrigin" required>
        <option value="">Origin</option>
        {{#each cities}}
        <option value="{{code}}">{{code}} - {{name}}</option>
        {{/each}}
      </select>
      <select id="editDestination" required>
        <option value="">Destination</option>
        {{#each cities}}
        <option value="{{code}}">{{code}} - {{name}}</option>
        {{/each}}
      </select>
      <input type="datetime-local" id="editSchedule" required>
      <input type="number" id="editPrice" placeholder="Price" required min="0" step="0.01">
      <input type="text" id="editAircraftType" placeholder="Aircraft Type" required>
      <input type="number" id="editSeatCapacity" placeholder="Seat Capacity" required min="1">
      <input type="number" id="editSeatsAvailable" placeholder="Seats Available" required min="0">
      <input type="text" id="editAirline" placeholder="Airline Name" required>
      <button type="submit">Save Changes</button>
    </form>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script>
  $(document).ready(function() {
    const user = {{{ userJSON }}};

    const buildAuthHeaders = (includeJson = false) => {
      const headers = {
        'X-User-Id': userId
      };

      if (includeJson) {
        headers['Content-Type'] = 'application/json';
      }

      return headers;
    };

    loadAllFlights();

    $('#oneWay').on('change', function() {
      if ($(this).is(':checked')) {
        $('#returnDateContainer').hide();
        $('#returnDate').removeAttr('required');
      }
    });

    $('#roundTrip').on('change', function() {
      if ($(this).is(':checked')) {
        $('#returnDateContainer').show();
        $('#returnDate').attr('required', true);
      }
    });

    $('#flightSearchForm').on('submit', function(e) {
      e.preventDefault();
      const origin = $('#searchOrigin').val();
      const destination = $('#searchDestination').val();
      const departureDate = $('#departureDate').val();
      
      $('#flightResults').html(`<p class="text-info">Searching for flights from ${origin} to ${destination} on ${departureDate}...</p>`);
    });

    function loadAllFlights() {
      $.ajax({
        url: '/flights/all',
        method: 'GET',
        headers: buildAuthHeaders(),
        success: function(response) {
          if (response.success) {
            renderFlights(response.data);
            $('#flightsLoading').hide();
            $('#flightTable').show();
          }
        },
        error: function(xhr) {
          console.error('Error loading flights:', xhr);
          $('#flightsLoading').html('<p class="text-danger">Error loading flights. Please refresh the page.</p>');
        }
      });
    }

    function renderFlights(flights) {
      const $tbody = $('#flightTableBody');
      $tbody.empty();

      if (flights.length === 0) {
        $tbody.html('<tr><td colspan="10" class="text-center">No flights found. Create your first flight above.</td></tr>');
        return;
      }

      const numberFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

      flights.forEach(function(flight) {
        const scheduleDate = flight.schedule ? new Date(flight.schedule) : null;
        const formattedSchedule = scheduleDate
          ? scheduleDate.toLocaleString('en-US', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            })
          : 'N/A';

        const priceValue = typeof flight.price === 'number' ? flight.price : Number(flight.price);
        const formattedPrice = Number.isFinite(priceValue)
          ? numberFormatter.format(priceValue)
          : 'N/A';

        const seatsAvailable = (typeof flight.seatsAvailable === 'number')
          ? flight.seatsAvailable
          : flight.seatCapacity;

        const row = `
          <tr data-id="${flight._id}">
            <td>${flight.flightNumber}</td>
            <td>${flight.origin}</td>
            <td>${flight.destination}</td>
            <td>${formattedSchedule}</td>
            <td>${formattedPrice}</td>
            <td>${flight.aircraftType}</td>
            <td>${flight.seatCapacity}</td>
            <td>${seatsAvailable}</td>
            <td>${flight.airline}</td>
            <td>
              <button class="action-btn edit-btn" data-id="${flight._id}">Edit</button>
              <button class="action-btn delete-btn" data-id="${flight._id}">Delete</button>
            </td>
          </tr>
        `;
        $tbody.append(row);
      });
    }

    $('#newFlightForm').on('submit', function(e) {
      e.preventDefault();
      
      const scheduleValue = $('#newSchedule').val();
      const scheduleDate = scheduleValue ? new Date(scheduleValue) : null;

      if (!scheduleDate || Number.isNaN(scheduleDate.getTime())) {
        alert('Please provide a valid departure date and time.');
        return;
      }

      const seatCapacityValue = parseInt($('#newSeatCapacity').val(), 10);
      if (Number.isNaN(seatCapacityValue) || seatCapacityValue < 1) {
        alert('Seat capacity must be at least 1.');
        return;
      }
      const flightData = {
        flightNumber: $('#newFlightNumber').val().toUpperCase(),
        origin: $('#newOrigin').val(),
        destination: $('#newDestination').val(),
        schedule: scheduleDate.toISOString(),
        price: parseFloat($('#newPrice').val()),
        aircraftType: $('#newAircraftType').val(),
        seatCapacity: seatCapacityValue,
        airline: $('#newAirline').val(),
        seatsAvailable: seatCapacityValue
      };

      if (flightData.origin === flightData.destination) {
        alert('Origin and destination must be different.');
        return;
      }

      if (Number.isNaN(flightData.price)) {
        alert('Please provide a valid price.');
        return;
      }

      $.ajax({
        url: '/flights',
        method: 'POST',
        headers: buildAuthHeaders(true),
        data: JSON.stringify(flightData),
        success: function(response) {
          if (response.success) {
            alert('Flight created successfully!');
            $('#newFlightForm')[0].reset();
            loadAllFlights();
          }
        },
        error: function(xhr) {
          const errorMsg = xhr.responseJSON?.message || 'Error creating flight';
          alert('Error: ' + errorMsg);
        }
      });
    });

    // Edit flight - open modal
    $(document).on('click', '.edit-btn', function() {
      const flightId = $(this).data('id');
      
      $.ajax({
        url: `/flights/${flightId}`,
        method: 'GET',
        headers: buildAuthHeaders(),
        success: function(response) {
          if (response.success) {
            const flight = response.data;
            const scheduleDate = flight.schedule ? new Date(flight.schedule) : null;
            const localDateTime = scheduleDate ? scheduleDate.toISOString().slice(0, 16) : '';

            $('#editFlightId').val(flight._id);
            $('#editFlightNumber').val(flight.flightNumber);
            $('#editOrigin').val(flight.origin);
            $('#editDestination').val(flight.destination);
            $('#editSchedule').val(localDateTime);
            $('#editAircraftType').val(flight.aircraftType);
            $('#editPrice').val(flight.price ?? 0);
            $('#editSeatCapacity').val(flight.seatCapacity);
            $('#editSeatsAvailable').val(flight.seatsAvailable ?? flight.seatCapacity);
            $('#editAirline').val(flight.airline);
            $('#editSeatCapacity').trigger('input');
            
            $('#editModal').css('display', 'block');
          }
        },
        error: function(xhr) {
          alert('Error loading flight details');
        }
      });
    });

    $('#editFlightForm').on('submit', function(e) {
      e.preventDefault();
      
      const flightId = $('#editFlightId').val();
      const scheduleValue = $('#editSchedule').val();
      const scheduleDate = scheduleValue ? new Date(scheduleValue) : null;

      if (!scheduleDate || Number.isNaN(scheduleDate.getTime())) {
        alert('Please provide a valid departure date and time.');
        return;
      }

      const seatCapacityValue = parseInt($('#editSeatCapacity').val(), 10);
      const seatsAvailableValue = parseInt($('#editSeatsAvailable').val(), 10);
      const flightData = {
        flightNumber: $('#editFlightNumber').val().toUpperCase(),
        origin: $('#editOrigin').val(),
        destination: $('#editDestination').val(),
        schedule: scheduleDate.toISOString(),
        price: parseFloat($('#editPrice').val()),
        aircraftType: $('#editAircraftType').val(),
        seatCapacity: seatCapacityValue,
        seatsAvailable: seatsAvailableValue,
        airline: $('#editAirline').val()
      };

      if (flightData.origin === flightData.destination) {
        alert('Origin and destination must be different.');
        return;
      }

      if (Number.isNaN(flightData.price)) {
        alert('Please provide a valid price.');
        return;
      }

      if (Number.isNaN(seatCapacityValue) || seatCapacityValue < 1) {
        alert('Seat capacity must be at least 1.');
        return;
      }

      if (Number.isNaN(flightData.seatsAvailable) || flightData.seatsAvailable < 0) {
        alert('Seats available must be zero or a positive number.');
        return;
      }

      if (flightData.seatsAvailable > flightData.seatCapacity) {
        alert('Seats available cannot exceed seat capacity.');
        return;
      }

      $.ajax({
        url: `/flights/${flightId}`,
        method: 'PUT',
        headers: buildAuthHeaders(true),
        data: JSON.stringify(flightData),
        success: function(response) {
          if (response.success) {
            alert('Flight updated successfully!');
            $('#editModal').css('display', 'none');
            loadAllFlights();
          }
        },
        error: function(xhr) {
          const errorMsg = xhr.responseJSON?.message || 'Error updating flight';
          alert('Error: ' + errorMsg);
        }
      });
    });

    $('#editSeatCapacity').on('input', function() {
      const capacity = parseInt($(this).val(), 10) || 0;
      const $seatsAvailable = $('#editSeatsAvailable');
      if (capacity > 0) {
        $seatsAvailable.attr('max', capacity);
      } else {
        $seatsAvailable.removeAttr('max');
      }

      const currentSeatsAvailable = parseInt($seatsAvailable.val(), 10);
      if (!Number.isNaN(currentSeatsAvailable) && capacity > 0 && currentSeatsAvailable > capacity) {
        $seatsAvailable.val(capacity);
      }
    });

    $(document).on('click', '.delete-btn', function() {
      const flightId = $(this).data('id');
      const flightNumber = $(this).closest('tr').find('td:first').text();
      
      if (confirm(`Are you sure you want to DELETE flight ${flightNumber}?`)) {
        $.ajax({
          url: `/flights/${flightId}`,
          method: 'DELETE',
          headers: buildAuthHeaders(),
          success: function(response) {
            if (response.success) {
              alert('Flight deleted successfully!');
              loadAllFlights();
            }
          },
          error: function(xhr) {
            alert('Error deleting flight');
          }
        });
      }
    });

    $('.close-btn, .modal').on('click', function(e) {
      if ($(e.target).hasClass('close-btn') || $(e.target).hasClass('modal')) {
        $('#editModal').css('display', 'none');
      }
    });

    var carouselElement = document.querySelector('#carouselExampleSlidesOnly');
    if (carouselElement) {
      var carousel = new bootstrap.Carousel(carouselElement, {
        interval: 7000,
        ride: "carousel",
        wrap: true,
        pause: "hover"
      });
    }
  });
</script>

<script>
    const user = {{{ userJSON }}};
    const resLink = document.querySelector('a.nav-link[href="/reservations"]');
    
    if (resLink && user) {
      if (user.role === "Admin") {
        resLink.href = "/reservations";
      } else {
        resLink.href = `/reservations?userId=${user._id}`;
      }
    }
</script>
</body>
</html>